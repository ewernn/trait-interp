<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trait Interp Visualization</title>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax loaded');
                }
            }
        };
    </script>

    <!-- External Dependencies -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="/visualization/styles.css">
</head>
<body>
    <!-- Preview modal (global) -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="preview-title" style="margin: 0; color: var(--text-primary);"></h3>
                <button class="close-btn" onclick="closePreview()">√ó</button>
            </div>
            <div class="preview-body" id="preview-body"></div>
        </div>
    </div>

    <!-- Info tooltip (global) -->
    <div class="info-tooltip" id="info-tooltip">
        <h3>üìä Trait Interpretation Visualization</h3>

        <h4>üîß Tools:</h4>
        <ul>
            <li><strong>Data Explorer</strong> - Inspect file structure, sizes, and preview data</li>
            <li><strong>Overview</strong> - Browse all extracted traits with metadata and example counts</li>
            <li><strong>Vector Analysis</strong> - Compare extraction methods across 27 layers with heatmaps</li>
            <li><strong>All Layers</strong> - View trait evolution across all 27 layers (Tier 2 data)</li>
            <li><strong>Layer Deep Dive</strong> - Analyze attention heads and top neurons for one layer (Tier 3 data)</li>
        </ul>

        <h4>üß† Available Traits (16 cognitive primitives):</h4>
        <div class="trait-list">
            <li>refusal</li>
            <li>uncertainty_calibration</li>
            <li>sycophancy</li>
            <li>retrieval_construction</li>
            <li>commitment_strength</li>
            <li>abstract_concrete</li>
            <li>cognitive_load</li>
            <li>context_adherence</li>
            <li>convergent_divergent</li>
            <li>emotional_valence</li>
            <li>instruction_boundary</li>
            <li>local_global</li>
            <li>paranoia_trust</li>
            <li>power_dynamics</li>
            <li>serial_parallel</li>
            <li>temporal_focus</li>
        </div>

        <h4>üí° Quick Tips:</h4>
        <ul>
            <li>Select traits in the sidebar to filter data</li>
            <li>Use the theme toggle (üåô/‚òÄÔ∏è) for dark mode</li>
            <li>Separation scores >40 indicate excellent quality</li>
        </ul>
    </div>

    <div class="container">
        <!-- Transformer Architecture Visualization -->
        <!-- <div class="transformer-sidebar" id="transformer-sidebar">
            <div class="transformer-header">
                <div class="transformer-title">Architecture</div>
                <button class="transformer-toggle" id="transformer-toggle" title="Hide architecture">‚óÄ</button>
            </div>
            <div class="transformer-content">
                <iframe
                    src="/visualization/transformer_diagram.html"
                    style="width: 100%; height: 1800px; border: none; display: block;"
                    title="Transformer Decoder Layer Diagram"
                    scrolling="no">
                </iframe>
            </div>
        </div> -->

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Trait Interp</div>
                <div class="sidebar-subtitle">Vector Visualization</div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Experiments</div>
                <div id="experiment-list">
                    <div class="nav-item" style="opacity: 0.5; cursor: default;">Loading...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Extraction</div>
                <div id="nav-items-extraction">
                    <div class="nav-item active" data-view="data-explorer">
                        <span class="icon">üóÇÔ∏è</span>
                        <span>Data Explorer</span>
                    </div>
                    <div class="nav-item" data-view="vector-analysis">
                        <span class="icon">üî¨</span>
                        <span>Vector Analysis</span>
                    </div>
                    <div class="nav-item" data-view="trait-correlation">
                        <span class="icon">üìä</span>
                        <span>Trait Correlation</span>
                    </div>
                    <div class="nav-item" data-view="validation-results">
                        <span class="icon">‚úÖ</span>
                        <span>Validation Results</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Inference</div>
                <div id="nav-items-inference">
                    <div class="nav-item" data-view="all-layers">
                        <span class="icon">‚ö°</span>
                        <span>All Layers</span>
                    </div>
                    <div class="nav-item" data-view="per-token-activation">
                        <span class="icon">üìç</span>
                        <span>Per-Token Activation</span>
                    </div>
                    <div class="nav-item" data-view="layer-deep-dive">
                        <span class="icon">üîç</span>
                        <span>Layer Deep Dive</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    Selected Traits (<span id="selected-count">0</span>)
                </div>
                <button class="select-all-btn" id="select-all-btn">Select All</button>
                <div id="trait-checkboxes"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="header-left">
                    <button class="info-btn" id="info-btn" title="Information">‚ÑπÔ∏è</button>
                    <div class="page-title" id="page-title">Overview</div>
                    <div class="experiment-badge" id="experiment-badge">-</div>
                    <div id="prompt-selector" class="prompt-selector-container">
                        <!-- Boxes will be dynamically inserted here -->
                    </div>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">üåô</button>
                </div>
            </header>

            <div class="content-wrapper" id="content-area">
                <div class="loading">Loading experiment data...</div>
            </div>
        </div>
    </div>

    <!-- Application Modules -->
    <script src="/visualization/core/paths.js"></script>
    <script src="/visualization/core/state.js"></script>
    <script src="/visualization/core/data-loader.js"></script>

    <!-- View Modules -->
    <script src="/visualization/views/data-explorer.js"></script>
    <script src="/visualization/views/vector-analysis.js"></script>
    <script src="/visualization/views/trait-correlation.js"></script>
    <script src="/visualization/views/validation-results.js"></script>
    <script src="/visualization/views/all-layers.js"></script>
    <script src="/visualization/views/per-token-activation.js"></script>
    <script src="/visualization/views/layer-deep-dive.js"></script>

    <!-- View Router -->
    <script>
        // Simple view router - calls appropriate render function based on current view
        window.renderView = function() {
            const view = window.state.currentView;

            switch (view) {
                case 'data-explorer':
                    window.renderDataExplorer();
                    break;
                case 'vector-analysis':
                    window.renderVectorAnalysis();
                    break;
                case 'trait-correlation':
                    window.renderTraitCorrelation();
                    break;
                case 'validation-results':
                    window.renderValidationResults();
                    break;
                case 'all-layers':
                    window.renderAllLayers();
                    break;
                case 'per-token-activation':
                    window.renderPerTokenActivation();
                    break;
                case 'layer-deep-dive':
                    window.renderLayerDeepDive();
                    break;
                default:
                    document.getElementById('content-area').innerHTML =
                        '<div class="error">Unknown view: ' + view + '</div>';
            }
        };

        // Initialize application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }
    </script>
</body>
</html>
