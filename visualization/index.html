<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trait Interp Visualization</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%231a1a1a'/><path d='M4 22 Q10 8, 16 16 T28 10' stroke='%23a09f6c' stroke-width='3' fill='none' stroke-linecap='round'/><circle cx='28' cy='10' r='2.5' fill='%23a09f6c'/></svg>">

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax loaded');
                }
            }
        };
    </script>

    <!-- External Dependencies -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- Overview Tab Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="/visualization/styles.css">
</head>
<body>
    <!-- Preview modal (global) -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="preview-title" style="margin: 0; color: var(--text-primary);"></h3>
                <button class="close-btn" onclick="closePreview()">Ã—</button>
            </div>
            <div class="preview-body" id="preview-body"></div>
        </div>
    </div>

    <div class="container">
        <!-- Transformer Architecture Visualization -->
        <!-- <div class="transformer-sidebar" id="transformer-sidebar">
            <div class="transformer-header">
                <div class="transformer-title">Architecture</div>
                <button class="transformer-toggle" id="transformer-toggle" title="Hide architecture">â—€</button>
            </div>
            <div class="transformer-content">
                <iframe
                    src="/visualization/transformer_diagram.html"
                    style="width: 100%; height: 1800px; border: none; display: block;"
                    title="Transformer Decoder Layer Diagram"
                    scrolling="no">
                </iframe>
            </div>
        </div> -->

        <!-- Sidebar Toggle (mobile) -->
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">â˜°</button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <div class="sidebar-title">Trait Interp</div>
                    <div class="sidebar-subtitle">Vector Visualization</div>
                </div>
                <button class="sidebar-collapse-btn" id="sidebar-collapse" title="Collapse sidebar">â—€</button>
            </div>

            <div class="sidebar-section">
                <div class="nav-item active" data-view="overview">
                    <span class="icon">ðŸ“–</span>
                    <span>Overview</span>
                </div>
                <div class="nav-item" data-view="findings">
                    <span class="icon">ðŸ“Š</span>
                    <span>Findings</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Experiments</div>
                <div id="experiment-list">
                    <div class="nav-item" style="opacity: 0.5; cursor: default;">Loading...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Analysis</div>
                <div id="nav-items-extraction">
                    <div class="nav-item" data-view="trait-extraction">
                        <span class="icon">ðŸ”¬</span>
                        <span>Trait Extraction</span>
                    </div>
                    <div class="nav-item" data-view="inference">
                        <span class="icon">ðŸ“ˆ</span>
                        <span>Inference</span>
                    </div>
                    <div class="nav-item" data-view="live-chat">
                        <span class="icon">ðŸ’¬</span>
                        <span>Live Chat</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    Selected Traits (<span id="selected-count">0</span>)
                </div>
                <button class="select-all-btn" id="select-all-btn">Select All</button>
                <div id="trait-checkboxes"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="page-title" id="page-title">Overview</div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">ðŸŒ™</button>
                </div>
            </header>

            <div class="content-wrapper" id="content-area">
                <div class="loading">Loading experiment data...</div>
            </div>

            <!-- Prompt Picker: fixed at bottom (only for inference views) -->
            <div id="prompt-picker" style="display: none;">
                <!-- Populated by renderPromptPicker() in prompt-picker.js -->
            </div>
        </div>
    </div>

    <!-- Application Modules -->
    <script src="/visualization/core/utils.js"></script>
    <script src="/visualization/core/paths.js"></script>
    <script src="/visualization/core/model-config.js"></script>
    <script src="/visualization/core/state.js"></script>
    <script src="/visualization/core/prompt-picker.js"></script>
    <script src="/visualization/core/conversation-tree.js"></script>

    <!-- View Modules -->
    <script src="/visualization/views/overview.js"></script>
    <script src="/visualization/views/findings.js"></script>
    <script src="/visualization/views/data-explorer.js"></script>
    <script src="/visualization/views/trait-extraction.js"></script>
    <script src="/visualization/views/trait-dynamics.js"></script>
    <script src="/visualization/views/layer-deep-dive.js"></script>
    <script src="/visualization/views/steering-sweep.js"></script>
    <script src="/visualization/views/live-chat.js"></script>

    <!-- View Router -->
    <script>
        // Simple view router - calls appropriate render function based on current view
        window.renderView = function() {
            const view = window.state.currentView;

            // Update page title
            const viewTitles = {
                'overview': 'Overview',
                'findings': 'Research Findings',
                'trait-extraction': 'Trait Extraction',
                'inference': 'Inference',
                'live-chat': 'Live Chat'
            };
            document.getElementById('page-title').textContent = viewTitles[view] || 'Unknown View';

            switch (view) {
                case 'overview':
                    window.renderOverview();
                    break;
                case 'findings':
                    window.renderFindings();
                    break;
                case 'trait-extraction':
                    window.renderTraitExtraction();
                    break;
                case 'inference':
                    window.renderTraitDynamics();  // Keep function name for now
                    break;
                case 'live-chat':
                    window.renderLiveChat();
                    break;
                default:
                    document.getElementById('content-area').innerHTML =
                        '<div class="error">Unknown view: ' + view + '</div>';
            }
        };

        // Initialize application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }

        // Sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const collapseBtn = document.getElementById('sidebar-collapse');
            const toggleBtn = document.getElementById('sidebar-toggle');

            // Desktop collapse button
            collapseBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                collapseBtn.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
            });

            // Mobile toggle button
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
            });

            // Close mobile sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 &&
                    sidebar.classList.contains('mobile-open') &&
                    !sidebar.contains(e.target) &&
                    e.target !== toggleBtn) {
                    sidebar.classList.remove('mobile-open');
                }
            });
        });
    </script>
</body>
</html>
