<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trait Interp Visualization</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%231a1a1a'/><path d='M4 22 Q10 8, 16 16 T28 10' stroke='%23a09f6c' stroke-width='3' fill='none' stroke-linecap='round'/><circle cx='28' cy='10' r='2.5' fill='%23a09f6c'/></svg>">

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax loaded');
                }
            }
        };
    </script>

    <!-- External Dependencies -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- Overview Tab Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="/visualization/styles.css">
</head>
<body>
    <!-- Preview modal (global) -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="preview-title" style="margin: 0; color: var(--text-primary);"></h3>
                <button class="close-btn" onclick="closePreview()">Ã—</button>
            </div>
            <div class="preview-body" id="preview-body"></div>
        </div>
    </div>

    <div class="container">
        <!-- Transformer Architecture Visualization -->
        <!-- <div class="transformer-sidebar" id="transformer-sidebar">
            <div class="transformer-header">
                <div class="transformer-title">Architecture</div>
                <button class="transformer-toggle" id="transformer-toggle" title="Hide architecture">â—€</button>
            </div>
            <div class="transformer-content">
                <iframe
                    src="/visualization/transformer_diagram.html"
                    style="width: 100%; height: 1800px; border: none; display: block;"
                    title="Transformer Decoder Layer Diagram"
                    scrolling="no">
                </iframe>
            </div>
        </div> -->

        <!-- Sidebar Toggle (mobile) -->
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">â˜°</button>

        <!-- Main Nav (always visible) -->
        <div class="sidebar sidebar-main" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <div class="sidebar-title">Trait Interp</div>
                    <div class="sidebar-subtitle">Vector Visualization</div>
                </div>
                <button class="sidebar-collapse-btn" id="sidebar-collapse" title="Collapse sidebar">â—€</button>
            </div>

            <div class="sidebar-section">
                <div class="nav-item" data-view="live-chat">Live Chat</div>
                <div class="nav-item active" data-view="overview">Overview</div>
                <div class="nav-item" data-view="methodology">Methodology</div>
                <div class="nav-item" data-view="findings">Findings</div>
            </div>

            <div class="sidebar-section">
                <div class="nav-item" id="analysis-entry">Analysis</div>
            </div>
        </div>

        <!-- Analysis Panel (conditional) -->
        <div class="sidebar sidebar-analysis hidden" id="sidebar-analysis">
            <div class="sidebar-section">
                <div class="section-title">Analysis</div>
                <div class="nav-item" data-view="trait-extraction">Extraction</div>
                <div class="nav-item" data-view="steering-sweep">Steering</div>
                <div class="nav-item" data-view="inference">Inference</div>
                <div class="nav-item" data-view="trait-correlation">Correlation</div>
                <div class="nav-item" data-view="model-comparison">Model Analysis</div>
                <div class="nav-item" data-view="one-offs">One-Offs</div>
            </div>

            <div class="sidebar-section" id="experiment-section">
                <div class="section-title">Experiment</div>
                <div id="experiment-list" class="experiment-picker">
                    <div class="experiment-option" style="opacity: 0.5;">Loading...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    Selected Traits (<span id="selected-count">0</span>)
                </div>
                <button class="select-all-btn" id="select-all-btn">Select All</button>
                <div id="trait-checkboxes"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="page-title" id="page-title">Overview</div>
                <div class="header-right">
                    <div id="gpu-status" class="gpu-status" title="GPU Status">
                        <span class="gpu-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                                <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            </svg>
                        </span>
                        <span class="gpu-name">--</span>
                        <span class="gpu-memory"></span>
                    </div>
                    <button id="reset-storage-btn" class="reset-storage-btn" title="Reset localStorage to defaults" style="display: none;" onclick="window.resetLocalStorage()">Reset</button>
                    <a href="https://github.com/ewernn/trait-interp" target="_blank" rel="noopener" class="github-link" title="View on GitHub">
                        <svg viewBox="0 0 16 16" width="20" height="20" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                    </a>
                    <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">ðŸŒ™</button>
                </div>
            </header>

            <div class="content-wrapper" id="content-area">
                <div class="loading">Loading experiment data...</div>
            </div>

            <!-- Prompt Picker: fixed at bottom (only for inference views) -->
            <div id="prompt-picker" style="display: none;">
                <!-- Populated by renderPromptPicker() in prompt-picker.js -->
            </div>
        </div>
    </div>

    <!-- Core Utilities (pure functions, no DOM, no deps) -->
    <script src="/visualization/core/types.js"></script>
    <script src="/visualization/core/utils.js"></script>
    <script src="/visualization/core/annotations.js"></script>
    <script src="/visualization/core/ui.js"></script>
    <script src="/visualization/core/display.js"></script>
    <script src="/visualization/core/charts.js"></script>
    <script src="/visualization/core/chart-types.js"></script>
    <script src="/visualization/core/legend.js"></script>
    <script src="/visualization/core/paths.js"></script>
    <script src="/visualization/core/citations.js"></script>
    <script src="/visualization/core/model-config.js"></script>
    <script src="/visualization/core/conversation-tree.js"></script>

    <!-- State Management -->
    <script src="/visualization/core/state.js"></script>

    <!-- Components (depend on state + core) -->
    <script src="/visualization/components/sidebar.js"></script>
    <script src="/visualization/components/prompt-picker.js"></script>
    <script src="/visualization/components/custom-blocks.js"></script>
    <script src="/visualization/components/response-browser.js"></script>

    <!-- View Modules -->
    <script src="/visualization/views/overview.js"></script>
    <script src="/visualization/views/methodology.js"></script>
    <script src="/visualization/views/findings.js"></script>
    <script src="/visualization/views/trait-extraction.js"></script>
    <script src="/visualization/views/trait-dynamics.js"></script>
    <script src="/visualization/views/trait-correlation.js"></script>
    <script src="/visualization/views/layer-deep-dive.js"></script>
    <script src="/visualization/views/steering-sweep.js"></script>
    <script src="/visualization/views/model-comparison.js"></script>
    <script src="/visualization/views/live-chat.js"></script>
    <script src="/visualization/views/one-offs.js"></script>

    <!-- View Router -->
    <script>
        // Simple view router - calls appropriate render function based on current view
        window.renderView = function() {
            const view = window.state.currentView;

            // Update page title
            const viewTitles = {
                'overview': 'Overview',
                'methodology': 'Methodology',
                'findings': 'Research Findings',
                'trait-extraction': 'Trait Extraction',
                'steering-sweep': 'Steering Sweep',
                'inference': 'Inference',
                'trait-correlation': 'Trait Correlation',
                'model-comparison': 'Model Analysis',
                'live-chat': 'Live Chat',
                'one-offs': 'One-Offs'
            };
            document.getElementById('page-title').textContent = viewTitles[view] || 'Unknown View';

            switch (view) {
                case 'overview':
                    window.renderOverview();
                    break;
                case 'methodology':
                    window.renderMethodology();
                    break;
                case 'findings':
                    window.renderFindings();
                    break;
                case 'finding':  // Standalone view
                    window.renderFindings();
                    break;
                case 'trait-extraction':
                    window.renderTraitExtraction();
                    break;
                case 'steering-sweep':
                    window.renderSteeringSweep();
                    break;
                case 'inference':
                    window.renderTraitDynamics();  // Keep function name for now
                    break;
                case 'trait-correlation':
                    window.renderTraitCorrelation();
                    break;
                case 'model-comparison':
                    window.renderModelComparison();
                    break;
                case 'live-chat':
                    window.renderLiveChat();
                    break;
                case 'one-offs':
                    window.renderOneOffs();
                    break;
                default:
                    document.getElementById('content-area').innerHTML =
                        '<div class="error">Unknown view: ' + view + '</div>';
            }
        };

        // Initialize application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }

        // Sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const analysisPanel = document.getElementById('sidebar-analysis');
            const collapseBtn = document.getElementById('sidebar-collapse');
            const toggleBtn = document.getElementById('sidebar-toggle');

            // Desktop collapse button - collapses both sidebars
            collapseBtn.addEventListener('click', () => {
                const isCollapsing = !sidebar.classList.contains('collapsed');
                sidebar.classList.toggle('collapsed');
                if (analysisPanel) {
                    analysisPanel.classList.toggle('collapsed', isCollapsing);
                }
                collapseBtn.textContent = isCollapsing ? 'â–¶' : 'â—€';
            });

            // Mobile toggle button - opens both sidebars
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
                if (analysisPanel) {
                    analysisPanel.classList.toggle('mobile-open');
                }
            });

            // Close mobile sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 &&
                    sidebar.classList.contains('mobile-open') &&
                    !sidebar.contains(e.target) &&
                    !(analysisPanel && analysisPanel.contains(e.target)) &&
                    e.target !== toggleBtn) {
                    sidebar.classList.remove('mobile-open');
                    if (analysisPanel) analysisPanel.classList.remove('mobile-open');
                }
            });
        });
    </script>
</body>
</html>
