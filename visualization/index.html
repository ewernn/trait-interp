<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trait Interp Visualization</title>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax loaded');
                }
            }
        };
    </script>

    <!-- External Dependencies -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- Overview Tab Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="/visualization/styles.css">
</head>
<body>
    <!-- Preview modal (global) -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="preview-title" style="margin: 0; color: var(--text-primary);"></h3>
                <button class="close-btn" onclick="closePreview()">√ó</button>
            </div>
            <div class="preview-body" id="preview-body"></div>
        </div>
    </div>

    <!-- Info tooltip (global) -->
    <div class="info-tooltip" id="info-tooltip">
        <h3>üìä Trait Interpretation Visualization</h3>

        <h4>üîß Tools:</h4>
        <ul>
            <li><strong>Trait Development:</strong></li>
            <ul>
                <li><strong>Data Explorer</strong> - Inspect raw responses, activations, and vectors.</li>
                <li><strong>Trait Dashboard</strong> - Comprehensive view of a trait's vector properties and quality metrics.</li>
                <li><strong>Trait Correlation Matrix</strong> - Analyze relationships between trait vectors.</li>
            </ul>
            <li><strong>Inference Analysis:</strong></li>
            <ul>
                <li><strong>Trait Trajectory</strong> - View a single trait's activation across all layers.</li>
                <li><strong>Trait Dynamics</strong> - Watch the model think: trait activations evolving token-by-token.</li>
                <li><strong>Layer Deep Dive</strong> - Deep dive into a single layer's attention and MLP components.</li>
            </ul>
        </ul>

        <h4>üß† Available Traits (16 cognitive primitives):</h4>
        <div class="trait-list">
            <li>refusal</li>
            <li>uncertainty_calibration</li>
            <li>sycophancy</li>
            <li>retrieval_construction</li>
            <li>commitment_strength</li>
            <li>abstract_concrete</li>
            <li>cognitive_load</li>
            <li>context_adherence</li>
            <li>convergent_divergent</li>
            <li>emotional_valence</li>
            <li>instruction_boundary</li>
            <li>local_global</li>
            <li>paranoia_trust</li>
            <li>power_dynamics</li>
            <li>serial_parallel</li>
            <li>temporal_focus</li>
        </div>

        <h4>üí° Quick Tips:</h4>
        <ul>
            <li>Select traits in the sidebar to filter data</li>
            <li>Use the theme toggle (üåô/‚òÄÔ∏è) for dark mode</li>
            <li>Separation scores >40 indicate excellent quality</li>
        </ul>
    </div>

    <div class="container">
        <!-- Transformer Architecture Visualization -->
        <!-- <div class="transformer-sidebar" id="transformer-sidebar">
            <div class="transformer-header">
                <div class="transformer-title">Architecture</div>
                <button class="transformer-toggle" id="transformer-toggle" title="Hide architecture">‚óÄ</button>
            </div>
            <div class="transformer-content">
                <iframe
                    src="/visualization/transformer_diagram.html"
                    style="width: 100%; height: 1800px; border: none; display: block;"
                    title="Transformer Decoder Layer Diagram"
                    scrolling="no">
                </iframe>
            </div>
        </div> -->

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Trait Interp</div>
                <div class="sidebar-subtitle">Vector Visualization</div>
            </div>

            <div class="sidebar-section">
                <div class="nav-item active" data-view="overview">
                    <span class="icon">üìñ</span>
                    <span>Overview</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Experiments</div>
                <div id="experiment-list">
                    <div class="nav-item" style="opacity: 0.5; cursor: default;">Loading...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Trait Development</div>
                <div id="nav-items-extraction">
                    <div class="nav-item" data-view="data-explorer">
                        <span class="icon">üóÇÔ∏è</span>
                        <span>Data Explorer</span>
                    </div>
                    <div class="nav-item" data-view="trait-extraction">
                        <span class="icon">üî¨</span>
                        <span>Trait Extraction</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Inference Analysis</div>
                <div id="nav-items-inference">
                    <div class="nav-item" data-view="trait-trajectory">
                        <span class="icon">‚ö°</span>
                        <span>Trait Trajectory</span>
                    </div>
                    <div class="nav-item" data-view="trait-dynamics">
                        <span class="icon">üìà</span>
                        <span>Trait Dynamics</span>
                    </div>
                    <div class="nav-item" data-view="layer-deep-dive">
                        <span class="icon">üî¨</span>
                        <span>Layer Deep Dive</span>
                    </div>
                    <div class="nav-item" data-view="analysis-gallery">
                        <span class="icon">üñºÔ∏è</span>
                        <span>Analysis Gallery</span>
                    </div>
                    <div class="nav-item" data-view="token-explorer">
                        <span class="icon">üîç</span>
                        <span>Token Explorer</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    Selected Traits (<span id="selected-count">0</span>)
                </div>
                <button class="select-all-btn" id="select-all-btn">Select All</button>
                <div id="trait-checkboxes"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="header-left">
                    <button class="info-btn" id="info-btn" title="Information">‚ÑπÔ∏è</button>
                    <div class="page-title" id="page-title">Overview</div>
                    <div class="experiment-badge" id="experiment-badge">-</div>
                    </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">üåô</button>
                </div>
            </header>

            <!-- Inference Context: prompt picker + prompt/response display (only for inference views) -->
            <div id="inference-context" style="display: none;">
                <!-- Populated by renderInferenceContext() in state.js -->
            </div>

            <div class="content-wrapper" id="content-area">
                <div class="loading">Loading experiment data...</div>
            </div>
        </div>
    </div>

    <!-- Application Modules -->
    <script src="/visualization/core/paths.js"></script>
    <script src="/visualization/core/state.js"></script>

    <!-- View Modules -->
    <script src="/visualization/views/overview.js"></script>
    <script src="/visualization/views/data-explorer.js"></script>
    <script src="/visualization/views/trait-extraction.js"></script>
    <script src="/visualization/views/trait-trajectory.js"></script>
    <script src="/visualization/views/trait-dynamics.js"></script>
    <script src="/visualization/views/layer-deep-dive.js"></script>
    <script src="/visualization/views/analysis-gallery.js"></script>
    <script src="/visualization/views/token-explorer.js"></script>

    <!-- View Router -->
    <script>
        // Simple view router - calls appropriate render function based on current view
        window.renderView = function() {
            const view = window.state.currentView;

            // Update page title
            const viewTitles = {
                'overview': 'Overview',
                'data-explorer': 'Data Explorer',
                'trait-extraction': 'Trait Extraction',
                'trait-trajectory': 'Trait Trajectory',
                'trait-dynamics': 'Trait Dynamics',
                'layer-deep-dive': 'Layer Deep Dive',
                'analysis-gallery': 'Analysis Gallery',
                'token-explorer': 'Token Explorer'
            };
            document.getElementById('page-title').textContent = viewTitles[view] || 'Unknown View';

            switch (view) {
                case 'overview':
                    window.renderOverview();
                    break;
                case 'data-explorer':
                    window.renderDataExplorer();
                    break;
                case 'trait-extraction':
                    window.renderTraitExtraction();
                    break;
                case 'trait-trajectory':
                    window.renderTraitTrajectory();
                    break;
                case 'trait-dynamics':
                    window.renderTraitDynamics();
                    break;
                case 'layer-deep-dive':
                    window.renderLayerDeepDive();
                    break;
                case 'analysis-gallery':
                    window.renderAnalysisGallery();
                    break;
                case 'token-explorer':
                    window.renderTokenExplorer();
                    break;
                default:
                    document.getElementById('content-area').innerHTML =
                        '<div class="error">Unknown view: ' + view + '</div>';
            }
        };

        // Initialize application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }
    </script>
</body>
</html>
