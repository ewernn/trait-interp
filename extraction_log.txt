Layer selection: 28 of 61 layers
============================================================
EXTRACTION PIPELINE | mats-mental-state-circuits
Model: unsloth/Kimi-K2-Base | BASE (16 tokens)
Traits: 11
============================================================
Loading model: unsloth/Kimi-K2-Base...
  max_memory: 138869MiB x 8 GPUs
`torch_dtype` is deprecated! Use `dtype` instead!
Loading checkpoint shards:   0%|          | 0/61 [00:00<?, ?it/s]Loading checkpoint shards:   2%|▏         | 1/61 [00:00<00:38,  1.55it/s]Loading checkpoint shards:   2%|▏         | 1/61 [00:02<02:55,  2.92s/it]
Traceback (most recent call last):
  File "/home/dev/trait-interp/extraction/run_pipeline.py", line 417, in <module>
    run_pipeline(
  File "/home/dev/trait-interp/extraction/run_pipeline.py", line 174, in run_pipeline
    model, tokenizer = load_model_with_lora(extraction_model, lora_adapter=lora, load_in_8bit=load_in_8bit, load_in_4bit=load_in_4bit, bnb_4bit_quant_type=bnb_4bit_quant_type)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/utils/model.py", line 360, in load_model_with_lora
    model = AutoModelForCausalLM.from_pretrained(model_name, **model_kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/models/auto/auto_factory.py", line 597, in from_pretrained
    return model_class.from_pretrained(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/modeling_utils.py", line 277, in _wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/modeling_utils.py", line 5048, in from_pretrained
    ) = cls._load_pretrained_model(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/modeling_utils.py", line 5468, in _load_pretrained_model
    _error_msgs, disk_offload_index = load_shard_file(args)
                                      ^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/modeling_utils.py", line 843, in load_shard_file
    disk_offload_index = _load_state_dict_into_meta_model(
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/torch/utils/_contextlib.py", line 124, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/dev/trait-interp/.venv/lib/python3.11/site-packages/transformers/modeling_utils.py", line 770, in _load_state_dict_into_meta_model
    _load_parameter_into_model(model, param_name, param.to(param_device))
                                                  ^^^^^^^^^^^^^^^^^^^^^^
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 14.00 MiB. GPU 1 has a total capacity of 139.81 GiB of which 6.38 MiB is free. Process 2516875 has 10.48 GiB memory in use. Process 2517123 has 129.31 GiB memory in use. Of the allocated memory 9.97 GiB is allocated by PyTorch, and 2.56 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
